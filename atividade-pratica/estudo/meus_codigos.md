CREATE DATABASE relatorios_pessoais;]

-- Criação da tabela de categorias
CREATE TABLE IF NOT EXISTS categorias (
    categoria_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    CONSTRAINT uq_categorias_nome UNIQUE (nome),
    CONSTRAINT ck_categorias_nome_nao_vazio CHECK (char_length(trim(nome)) > 0)
);

-- Criação da tabela de formas de pagamento
CREATE TABLE IF NOT EXISTS formas_pagamento (
    forma_pagamento_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    codigo_externo VARCHAR(50), -- opcional: código usado por sistemas de pagamento
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    CONSTRAINT uq_formas_pagamento_nome UNIQUE (nome),
    CONSTRAINT ck_formas_pagamento_nome_nao_vazio CHECK (char_length(trim(nome)) > 0)
);

-- Criação da tabela de lançamentos (fato)
CREATE TABLE IF NOT EXISTS lancamentos (
    lancamento_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    descricao TEXT,
    valor NUMERIC(12,2) NOT NULL,
    data_lancamento DATE NOT NULL,
    categoria_id INT NOT NULL,
    forma_pagamento_id INT NOT NULL,
    observacao TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    -- Constraints / integridade
    CONSTRAINT ck_lancamentos_valor_nao_negativo CHECK (valor >= 0),
    CONSTRAINT fk_lancamentos_categoria FOREIGN KEY (categoria_id)
        REFERENCES categorias (categoria_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    CONSTRAINT fk_lancamentos_forma_pagamento FOREIGN KEY (forma_pagamento_id)
        REFERENCES formas_pagamento (forma_pagamento_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

-- Índices em colunas de FK para melhorar desempenho de joins/consultas
CREATE INDEX IF NOT EXISTS idx_lancamentos_categoria_id ON lancamentos (categoria_id);
CREATE INDEX IF NOT EXISTS idx_lancamentos_forma_pagamento_id ON lancamentos (forma_pagamento_id);

-- (Opcional) Índice composto para consultas por data e valor (ex.: relatórios)
CREATE INDEX IF NOT EXISTS idx_lancamentos_data_valor ON lancamentos (data_lancamento, valor);

--------------- inserindo

-- Inserir categorias
INSERT INTO categorias (nome) VALUES
('Alimentação'),
('Transporte'),
('Energia Elétrica'),
('Água'),
('Internet');

-- Inserir formas de pagamento
INSERT INTO formas_pagamento (nome) VALUES
('PIX'),
('Cartão de Crédito'),
('Débito'),
('Dinheiro');

-- Inserir lançamentos (exemplos)
INSERT INTO lancamentos (descricao, valor, data_lancamento, categoria_id, forma_pagamento_id) VALUES
('Supermercado - Mercadão', 250.75, '2025-10-01', 1, 2),
('Conta de Luz - CEMIG', 120.40, '2025-09-25', 3, 3),
('Assinatura Internet', 99.90, '2025-09-30', 5, 2),
('Táxi aeroporto', 68.00, '2025-10-02', 2, 1);

------ alterando

UPDATE lancamentos
SET valor = ROUND(valor * 1.05, 2)
WHERE data_lancamento < '2025-10-01';

-- parte 6

SELECT 
    l.descricao,
    l.valor,
    l.data_lancamento,
    c.nome,
    fp.nome
FROM
    lancamentos l
JOIN
    categorias c
    ON l.categoria_id = c.categoria_id
JOIN  
    formas_pagamento



-- Mostrar valor, imposto de 8% e total com imposto
SELECT
    valor,
    valor * 0.08 AS imposto,
    ROUND(valor * 1.08, 2) AS valor_com_imposto
FROM 
    lancamentos;

-- Dividir valor em 3 parcelas
SELECT 
    valor, 
    ROUND(valor/3,2) AS valor_parcelado_3x
FROM
    lancamentos;

-- Resto da divisão por 10 (mod)
SELECT 
    valor,
    mod(valor, 10) AS resto_divisao
FROM 
    lancamentos;

------ questões

-- Liste a descricao, valor e data_lancamento de todos os lançamentos.
SELECT 
    descricao,
    valor, 
    data_lancamento
FROM
    lancamentos;

-- Mostre apenas os lançamentos com valor > 100.
SELECT 
    descricao,
    valor
FROM
    lancamentos
WHERE
    valor > 100;

-- Liste a descricao de cada lançamento e o nome da sua categoria.
SELECT 
    l.descricao,
    c.nome
FROM
    lancamentos l
JOIN
    categorias c
    ON l.categoria_id = c.categoria_id;


-- Mostre descricao, valor, categoria e forma de pagamento para todos os lançamentos (duas joins).
-- Qual o valor total gasto por categoria?
-- Quanto foi gasto no total usando "Cartão de Crédito"?
-- Quais lançamentos (descricao e valor) foram pagos com "PIX" e são da categoria "Alimentação"?
-- Atualize todos os lançamentos anteriores a 2025-10-01, aplicando correção de 4%, arredondando para 2 casas.
-- Crie uma VIEW que retorne descricao, valor, categoria e valor_com_imposto (8%).
-- Liste as 5 maiores despesas (descrição, valor, categoria).
-- Identifique categorias com gasto total maior que 1000 (use HAVING).
-- Conte quantas formas de pagamento diferentes foram usadas por categoria.
-- Encontre lançamentos cujo descricao contenha "conta" (case-insensitive).
-- Escreva uma query que retorne todas as categorias, incluindo aquelas sem lançamentos (use LEFT JOIN).
-- Modele a situação onde Pessoa pode ser Cliente e Fornecedor (mostre SQL para criação das tabelas no padrão Table per Class).
